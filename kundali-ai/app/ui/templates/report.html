<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kundali Report</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-svg { filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.05)); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; -webkit-appearance: none; -moz-appearance: none; appearance: none; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex flex-wrap justify-between items-center">
            <a href="index.html" class="text-xl font-extrabold tracking-tight flex items-center gap-2 text-indigo-600">
                <span class="bg-indigo-600 text-white p-1.5 rounded-lg text-sm">ðŸ”®</span> KUNDALI AI
            </a>
            <div class="flex gap-6 text-sm font-semibold text-slate-600 overflow-x-auto">
                <a href="index.html" class="hover:text-indigo-600 transition">Home</a>
                <a href="create.html" class="hover:text-indigo-600 transition">Create</a>
                <a href="ask.html" class="hover:text-indigo-600 transition">Ask AI</a>
                <a href="report.html" class="text-indigo-600 border-b-2 border-indigo-600 pb-1">Reports</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto mt-8 px-4 pb-12">
        <div id="loading" class="text-center py-20">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-indigo-600 border-t-transparent mb-4"></div>
            <p class="text-lg font-medium text-slate-500">Synthesizing your astrological data...</p>
        </div>

        <div id="report-content" class="hidden space-y-8">
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
                <div>
                    <h1 class="text-4xl font-black text-slate-900 tracking-tight">Personalized Analysis</h1>
                    <p class="text-slate-500 mt-1">Comprehensive Vedic insights based on your birth details.</p>
                </div>
                <button id="downloadPdfBtn" class="inline-flex items-center gap-2 bg-slate-900 hover:bg-slate-800 text-white font-bold py-2.5 px-6 rounded-xl shadow-lg transition duration-200 text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                    Export as PDF
                </button>
            </div>

            <div id="birth-particulars" class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200"></div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="flex flex-col md:flex-row md:items-center justify-between p-6 bg-slate-50 border-b border-slate-200 gap-4">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">Analysis & Predictions</h2>
                        <p class="text-xs text-slate-500 mt-0.5">AI-generated insights from your planetary positions</p>
                    </div>
                    <div class="relative w-full md:w-72">
                        <select id="topic-select" class="block w-full pl-4 pr-10 py-2 text-sm font-semibold border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 rounded-xl bg-white border transition-all cursor-pointer shadow-sm"></select>
                    </div>
                </div>
                <div id="active-prediction-content" class="p-8 md:p-10 min-h-[400px]"></div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-2xl font-bold mb-4 text-slate-700 border-b pb-2">Visual Charts</h2>
                <div id="visual-charts-container" class="grid grid-cols-1 md:grid-cols-2 gap-8"></div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-2xl font-bold mb-4 text-slate-700 border-b pb-2">Core Details</h2>
                <div id="core-details" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-2xl font-bold mb-4 text-slate-700 border-b pb-2">Planetary Positions</h2>
                <div id="planets-table-container" class="overflow-x-auto"></div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-2xl font-bold mb-4 text-slate-700 border-b pb-2">Vimshottari Dasha</h2>
                <div id="dasha-table-container" class="overflow-x-auto"></div>
            </div>
        </div>
    </div>

    <script>
        let reportData = null;
        const getApiBaseUrl = () => window.location.protocol === 'file:' ? 'http://127.0.0.1:8000' : '';
        const API_BASE = getApiBaseUrl();

        const renderTable = (headers, data, keyOrder) => {
            let table = '<table class="min-w-full divide-y divide-slate-100"><thead class="bg-slate-50"><tr>';
            headers.forEach(h => table += `<th class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-widest">${h}</th>`);
            table += '</tr></thead><tbody class="bg-white divide-y divide-slate-50">';
            if (Array.isArray(data)) {
                data.forEach(row => {
                    table += '<tr>';
                    keyOrder.forEach(key => table += `<td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700">${row[key] || '-'}</td>`);
                    table += '</tr>';
                });
            } else {
                 Object.entries(data).forEach(([name, row]) => {
                    table += '<tr><td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-slate-800">' + name + '</td>';
                    keyOrder.forEach(key => {
                        let value = row[key];
                        if (typeof value === 'number') value = value.toFixed(2);
                        if (key === 'retrograde') value = value ? 'Yes' : 'No';
                        table += `<td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700">${value || '-'}</td>`
                    });
                    table += '</tr>';
                });
            }
            return table + '</tbody></table>';
        };

        const renderKeyValue = (data) => {
            let html = '<dl class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';
            for (const [key, value] of Object.entries(data)) {
                html += `<div class="flex flex-col p-4 bg-slate-50 rounded-xl border border-slate-100"><dt class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</dt><dd class="text-sm font-semibold text-slate-800">${value}</dd></div>`;
            }
            return html + '</dl>';
        };

        const formatAiText = (text) => {
            if (!text) return '<p class="text-slate-400 italic">No data available.</p>';
            let formatted = text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-slate-900 font-extrabold">$1</strong>');
            return formatted.split('\n').map(line => {
                const trimmed = line.trim();
                if (trimmed.startsWith('-') || trimmed.startsWith('* ')) return `<div class="flex items-start mb-3 ml-4"><span class="mr-3 text-indigo-500 font-bold">â€¢</span><span class="text-slate-600">${trimmed.substring(1).trim().replace(/^\*\s*/, '')}</span></div>`;
                return trimmed ? `<p class="mb-5 text-slate-600 leading-relaxed text-base">${trimmed}</p>` : '<div class="h-2"></div>';
            }).join('');
        };

        const signs = ["Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo", "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"];
        const signMap = { "Aries": 1, "Taurus": 2, "Gemini": 3, "Cancer": 4, "Leo": 5, "Virgo": 6, "Libra": 7, "Scorpio": 8, "Sagittarius": 9, "Capricorn": 10, "Aquarius": 11, "Pisces": 12 };

        const drawNorthIndianChart = (containerId, houses, planets, title) => {
            const size = 300, ns = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(ns, "svg");
            svg.setAttribute("viewBox", `0 0 ${size} ${size}`);
            svg.setAttribute("class", "w-full h-auto border border-slate-100 bg-white rounded-2xl chart-svg");
            
            [`0,0 ${size},${size}`, `0,${size} ${size},0`, `0,0 ${size},0 ${size},${size} 0,${size} 0,0`, `${size/2},0 0,${size/2} ${size/2},${size} ${size},${size/2} ${size/2},0`]
            .forEach(pts => {
                const poly = document.createElementNS(ns, "polyline");
                poly.setAttribute("points", pts); poly.setAttribute("fill", "none"); poly.setAttribute("stroke", "#e2e8f0");
                svg.appendChild(poly);
            });

            const pos = { 1:[0.5, 0.20], 2:[0.25, 0.08], 3:[0.08, 0.25], 4:[0.25, 0.5], 5:[0.08, 0.75], 6:[0.25, 0.92], 7:[0.5, 0.80], 8:[0.75, 0.92], 9:[0.92, 0.75], 10:[0.75, 0.5], 11:[0.92, 0.25], 12:[0.75, 0.08] };
            const planetsByHouse = {};
            for(let i=1; i<=12; i++) planetsByHouse[i] = [];
            Object.entries(planets).forEach(([pName, pData]) => { if (pData.house) planetsByHouse[pData.house].push(pName.substring(0,2) + (pData.retrograde ? "(R)" : "")); });

            for (let h = 1; h <= 12; h++) {
                const [cx, cy] = [size * pos[h][0], size * pos[h][1]];
                const signText = document.createElementNS(ns, "text");
                signText.setAttribute("x", cx); signText.setAttribute("y", cy - 10);
                signText.setAttribute("text-anchor", "middle"); signText.setAttribute("font-weight", "800"); signText.setAttribute("fill", "#6366f1");
                signText.textContent = signMap[houses[h]] || "";
                svg.appendChild(signText);
                
                planetsByHouse[h].forEach((p, idx) => {
                    const pText = document.createElementNS(ns, "text");
                    pText.setAttribute("x", cx); pText.setAttribute("y", cy + 5 + (idx * 10));
                    pText.setAttribute("text-anchor", "middle"); pText.setAttribute("font-size", "11"); pText.setAttribute("fill", "#475569");
                    pText.textContent = p;
                    svg.appendChild(pText);
                });
            }
            
            const wrapper = document.createElement("div");
            wrapper.innerHTML = `<div class="text-center font-bold text-slate-500 text-sm mb-4 uppercase tracking-widest">${title}</div>`;
            wrapper.appendChild(svg);
            document.getElementById(containerId).appendChild(wrapper);
        };

        const loadReport = async () => {
            const kundaliId = new URLSearchParams(window.location.search).get('id') || localStorage.getItem('kundali_core_id');
            if (!kundaliId) return document.getElementById('loading').innerHTML = '<p class="text-red-500">No ID found.</p>';

            try {
                const res = await fetch(`${API_BASE}/api/v1/report/text?kundali_core_id=${kundaliId}&include_transits=true`);
                if (!res.ok) throw new Error('Failed to fetch data');
                reportData = await res.json();

                document.getElementById('birth-particulars').innerHTML = `<h2 class="text-xl font-bold mb-6 text-slate-800 flex items-center gap-2"><span class="text-indigo-500">ðŸ‘¤</span> Profile: ${reportData.birth_details.name}</h2>${renderKeyValue(reportData.birth_details)}`;

                const topicSelect = document.getElementById('topic-select');
                const contentArea = document.getElementById('active-prediction-content');
                const sections = reportData.meta.sections || Object.keys(reportData.ai_predictions);
                topicSelect.innerHTML = sections.map(t => `<option value="${t}">${t}</option>`).join('');

                const updateTopic = (t) => {
                    contentArea.style.opacity = '0';
                    setTimeout(() => {
                        contentArea.innerHTML = `<div class="animate-fade-in"><h3 class="text-2xl font-black text-slate-900 mb-8 flex items-center"><span class="w-2 h-8 bg-indigo-600 rounded-full mr-4"></span>${t}</h3><div class="prose prose-slate max-w-none">${formatAiText(reportData.ai_predictions[t])}</div></div>`;
                        contentArea.style.opacity = '1';
                    }, 150);
                };
                topicSelect.addEventListener('change', (e) => updateTopic(e.target.value));
                if (sections.length) updateTopic(sections[0]);

                document.getElementById('visual-charts-container').innerHTML = '';
                if (reportData.persisted.core.houses) drawNorthIndianChart('visual-charts-container', reportData.persisted.core.houses, reportData.persisted.core.planets, "Lagna Chart (D1)");
                
                document.getElementById('core-details').innerHTML = renderKeyValue({ Ayanamsa: reportData.persisted.core.ayanamsa, Ascendant: `${reportData.persisted.core.ascendant.sign} (${reportData.persisted.core.ascendant.degree.toFixed(2)}Â°)` });
                
                document.getElementById('planets-table-container').innerHTML = renderTable(['Planet', 'Sign', 'Degree', 'House', 'Nakshatra', 'Retrograde'], reportData.persisted.core.planets, ['sign', 'degree', 'house', 'nakshatra', 'retrograde']);
                
                const formattedDashas = reportData.dashas.map(d => ({ ...d, start_date: d.start_date.split('T')[0], end_date: d.end_date.split('T')[0] }));
                document.getElementById('dasha-table-container').innerHTML = renderTable(['Dasha Lord', 'Start', 'End', 'Duration'], formattedDashas, ['lord', 'start_date', 'end_date', 'duration_years']);

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('report-content').classList.remove('hidden');
            } catch (e) { document.getElementById('loading').innerHTML = `<p class="text-red-500">Error: ${e.message}</p>`; }
        };

        const downloadPdf = async () => {
            const btn = document.getElementById('downloadPdfBtn');
            if(!reportData) return;
            btn.textContent = 'Generating...'; btn.disabled = true;
            try {
                const res = await fetch(`${API_BASE}/api/v1/report/pdf_from_data`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(reportData) });
                if (!res.ok) throw new Error(await res.text());
                const blob = await res.blob();
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = `report-${reportData.birth_details.name}.pdf`;
                link.click();
            } catch (e) { alert(e.message); }
            btn.textContent = 'Export as PDF'; btn.disabled = false;
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadReport();
            document.getElementById('downloadPdfBtn').addEventListener('click', downloadPdf);
        });
    </script>
</body>
</html> 