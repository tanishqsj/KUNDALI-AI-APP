<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ask the Stars - Kundali AI</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Outfit:wght@200;300;400;500;600&display=swap"
        rel="stylesheet">
    <!-- KaTeX for LaTeX rendering (loaded synchronously) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Outfit"', 'sans-serif'],
                    },
                    colors: {
                        cosmic: {
                            900: '#0B0B15',
                            800: '#151525',
                            accent: '#FFD700',
                            purple: '#6D28D9',
                            pink: '#EC4899'
                        }
                    },
                    animation: {
                        'spin-slow': 'spin 12s linear infinite',
                        'pulse-glow': 'pulseGlow 2s infinite',
                    },
                    keyframes: {
                        pulseGlow: {
                            '0%, 100%': { boxShadow: '0 0 5px rgba(236, 72, 153, 0.5)' },
                            '50%': { boxShadow: '0 0 20px rgba(236, 72, 153, 0.8)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #050505;
            color: #cbd5e1;
            overflow-x: hidden;
        }

        /* Starfield Background */
        #star-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(circle at center, #1a1a2e 0%, #050505 100%);
        }

        .glass-panel {
            background: rgba(20, 20, 35, 0.6);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s;
        }

        .glass-input:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: #a855f7;
            outline: none;
            box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.2);
        }

        /* Chat Scrollbar */
        #chatBox::-webkit-scrollbar {
            width: 6px;
        }

        #chatBox::-webkit-scrollbar-track {
            background: transparent;
        }

        #chatBox::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 10px;
        }

        #chatBox::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* KaTeX Dark Theme Styling */
        .katex-display {
            background-color: rgba(0, 0, 0, 0.2) !important;
            color: #f1f5f9 !important;
            padding: 1rem !important;
            border-radius: 0.5rem !important;
            font-size: 1rem !important;

            /* Layout */
            display: block !important;
            min-height: 2em !important;
            overflow-x: auto !important;
            position: relative !important;
            margin: 1rem 0 !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        /* Inline math styling */
        .katex {
            color: #e2e8f0 !important;
            font-size: 1.05em !important;
        }

        /* Ensure all internal elements inherit the light color */
        .katex-display .katex,
        .katex-display .katex * {
            color: #f1f5f9 !important;
            border-color: #94a3b8 !important;
        }

        /* Fix vlist positioning - this is often the culprit */
        .katex .vlist-t,
        .katex .vlist-t2,
        .katex .vlist-r,
        .katex .vlist,
        .katex .vlist-s {
            position: relative !important;
            display: inline-block !important;
            vertical-align: middle !important;
        }

        /* Force all nested elements visible */
        .katex span,
        .katex .mord,
        .katex .mbin,
        .katex .mrel,
        .katex .mopen,
        .katex .mclose,
        .katex .mpunct,
        .katex .minner,
        .katex .mtable,
        .katex .col-align-c,
        .katex .col-align-l,
        .katex .col-align-r {
            color: #f1f5f9 !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* Table specific fixes */
        .katex .mtable {
            display: inline-table !important;
            border-collapse: collapse !important;
        }

        .katex .arraycolsep {
            width: 0.5em !important;
        }

        /* Table borders */
        .katex .vertical-separator {
            border-left: 1px solid #94a3b8 !important;
            min-width: 1px !important;
            display: inline-block !important;
        }

        .katex .hline {
            border-top: 1px solid #94a3b8 !important;
            min-height: 1px !important;
            display: block !important;
            width: 100% !important;
        }

        /* Fix for strut elements that might push content */
        .katex .strut {
            display: inline-block !important;
        }

        /* Typing Cursor */
        .typing-cursor::after {
            content: '‚ñã';
            color: #a855f7;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        /* Visualizer */
        .visualizer-canvas {
            width: 100%;
            height: 40px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
        }

        /* Nav Link */
        .nav-link {
            position: relative;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 1px;
            bottom: -2px;
            left: 0;
            background-color: #F59E0B;
            transition: width 0.3s;
        }

        .nav-link:hover::after {
            width: 100%;
        }

        /* Message Bubbles */
        .msg-user {
            background: linear-gradient(135deg, #6D28D9 0%, #4C1D95 100%);
            color: white;
            border-bottom-right-radius: 2px;
            box-shadow: 0 4px 15px rgba(109, 40, 217, 0.3);
        }

        .msg-ai {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.05);
            color: #e2e8f0;
            border-bottom-left-radius: 2px;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">
    <canvas id="star-canvas"></canvas>

    <!-- Navigation -->
    <nav class="fixed w-full z-50 bg-black/50 backdrop-blur-md border-b border-white/5 transition-all duration-300">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-2 group">
                <div
                    class="w-8 h-8 rounded-full bg-gradient-to-tr from-purple-600 to-pink-500 flex items-center justify-center text-white text-xs shadow-lg group-hover:animate-spin-slow">
                    ‚ú¶</div>
                <span class="text-xl font-serif font-bold text-white tracking-widest uppercase">Kundali AI</span>
            </a>
            <div class="flex gap-8 text-sm font-medium tracking-wide">
                <a href="index.html" class="hover:text-amber-400 transition nav-link">Home</a>
                <a href="create.html" class="hover:text-amber-400 transition nav-link">Create Chart</a>
                <a href="ask.html" class="text-amber-400 nav-link">Ask Stars</a>
                <a href="matching.html" class="hover:text-amber-400 transition nav-link">Milan</a>
                <a href="report.html" class="hover:text-amber-400 transition nav-link">Reports</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto mt-20 p-4 max-w-4xl flex-grow flex flex-col h-[calc(100vh-80px)]">

        <!-- Chat Interface Container -->
        <div class="glass-panel rounded-2xl flex-grow flex flex-col overflow-hidden shadow-2xl relative">

            <!-- Context Bar -->
            <div
                class="p-4 border-b border-white/10 bg-black/20 flex items-center justify-between backdrop-blur-sm z-10">
                <div class="flex items-center gap-3 w-full">
                    <span class="text-xl">üîÆ</span>
                    <div class="flex-grow">
                        <input type="text" id="kundaliId"
                            class="w-full bg-transparent border-none text-xs font-mono text-purple-300 placeholder-slate-600 focus:ring-0 p-0"
                            placeholder="Enter Kundali ID..." autocomplete="off">
                    </div>
                </div>
                <div class="text-[10px] text-slate-500 uppercase tracking-widest font-bold hidden md:block">Vedic AI
                    Astrologer</div>
            </div>

            <!-- Messages Area -->
            <div id="chatBox" class="flex-grow overflow-y-auto p-4 md:p-6 space-y-6 relative">
                <!-- Background Logo -->
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-[0.03]">
                    <div class="w-64 h-64 border-8 border-current rounded-full"></div>
                </div>

                <div class="text-center text-slate-500 text-sm mt-10 animate-fade-in">
                    <div
                        class="w-16 h-16 bg-gradient-to-tr from-purple-900/50 to-pink-900/50 rounded-full flex items-center justify-center mx-auto mb-4 border border-white/10 shadow-[0_0_30px_rgba(168,85,247,0.2)]">
                        <span class="text-3xl">‚ú®</span>
                    </div>
                    <p class="font-serif text-lg text-white mb-2">Greetings, Seeker.</p>
                    <p class="opacity-75 max-w-xs mx-auto">I am aligned with your cosmic chart. Ask me about your
                        destiny, career, or relationships.</p>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 bg-black/20 border-t border-white/10 relative z-20">
                <form id="askForm" class="flex gap-3 items-end relative">
                    <button type="button" id="voiceBtn" title="Hold to Record"
                        class="p-4 rounded-xl bg-white/5 hover:bg-white/10 text-slate-400 hover:text-white border border-white/10 transition-all duration-200 group">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 group-hover:scale-110 transition"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                        </svg>
                    </button>

                    <div class="flex-grow relative">
                        <textarea id="question" rows="1"
                            class="w-full rounded-xl bg-white/5 border border-white/10 p-4 pr-12 text-white placeholder-slate-500 focus:bg-white/10 focus:border-purple-500/50 focus:ring-1 focus:ring-purple-500/50 focus:outline-none transition resize-none glass-input overflow-hidden"
                            placeholder="Type your question..."
                            oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                    </div>

                    <button type="submit"
                        class="p-4 bg-gradient-to-br from-purple-600 to-pink-600 text-white rounded-xl hover:shadow-[0_0_20px_rgba(168,85,247,0.4)] transition transform hover:-translate-y-0.5 font-bold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M14 5l7 7m0 0l-7 7m7-7H3" />
                        </svg>
                    </button>
                </form>

                <!-- Recording Status Overlay -->
                <div id="recordingStatus"
                    class="hidden absolute -top-16 left-1/2 transform -translate-x-1/2 bg-red-500/90 backdrop-blur-md text-white px-6 py-2 rounded-full text-xs font-bold shadow-[0_0_20px_rgba(239,68,68,0.6)] items-center gap-2 animate-pulse-glow border border-red-400/50">
                    <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span>
                    Listening to the cosmos...
                </div>
            </div>
        </div>
    </div>

    <script>
        const getApiBaseUrl = () => window.location.protocol === 'file:' ? 'http://127.0.0.1:8000' : '';
        const API_BASE = getApiBaseUrl();

        // Starfield
        const canvas = document.getElementById('star-canvas');
        const ctx = canvas.getContext('2d');
        let width, height, stars = [];
        const resize = () => { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; stars = Array(100).fill().map(() => ({ x: Math.random() * width, y: Math.random() * height, size: Math.random() * 1.5, opacity: Math.random(), speed: Math.random() * 0.05 })); };
        const draw = () => { ctx.clearRect(0, 0, width, height); const g = ctx.createRadialGradient(width / 2, height / 2, 0, width / 2, height / 2, width); g.addColorStop(0, '#1a0b2e'); g.addColorStop(1, '#050505'); ctx.fillStyle = g; ctx.fillRect(0, 0, width, height); stars.forEach(s => { ctx.fillStyle = `rgba(255,255,255,${s.opacity})`; ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2); ctx.fill(); s.opacity += 0.005 * (Math.random() > .5 ? 1 : -1); if (s.opacity < 0 || s.opacity > 1) s.opacity = Math.random(); }); requestAnimationFrame(draw); };
        window.addEventListener('resize', resize); resize(); draw();

        // Logic
        const urlParams = new URLSearchParams(window.location.search);
        const urlKundaliId = urlParams.get('kundali_id') || urlParams.get('id');
        const urlMatchId = urlParams.get('match_id');

        if (urlMatchId) {
            (async () => {
                try {
                    const res = await fetch(`${API_BASE}/api/v1/matching/match/${urlMatchId}`);
                    if (res.ok) {
                        const m = await res.json();
                        document.getElementById('kundaliId').value = m.boy_kundali_id; // Default to boy for context
                        localStorage.setItem('kundali_core_id', m.boy_kundali_id);
                        document.getElementById('chatBox').innerHTML = `
                            <div class="text-center text-sm bg-purple-900/30 border border-purple-500/30 p-4 rounded-xl backdrop-blur-md mx-auto max-w-sm">
                                <p class="font-bold text-purple-300 mb-2">üíï Compatibility Context Active</p>
                                <p class="text-white"><span class="text-blue-300">${m.boy_name}</span> & <span class="text-pink-300">${m.girl_name}</span></p>
                                <div class="mt-2 text-xs font-mono text-slate-400">Match Score: ${m.total_score}/36</div>
                            </div>`;
                    }
                } catch (e) { console.error(e); }
            })();
        } else if (urlKundaliId) {
            document.getElementById('kundaliId').value = urlKundaliId;
            localStorage.setItem('kundali_core_id', urlKundaliId);
        } else {
            const stored = localStorage.getItem('kundali_core_id');
            if (stored) document.getElementById('kundaliId').value = stored;
        }

        const chatBox = document.getElementById('chatBox');

        function formatAiText(text) {
            if (!text) return '';

            // Helper: Try to render LaTeX, fallback to styled code block
            function tryRenderKatex(latex, displayMode) {
                // Check if KaTeX is loaded
                if (typeof katex === 'undefined') {
                    console.error('KaTeX not loaded!');
                    const escaped = latex.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    return `<code class="text-amber-300 bg-slate-700 px-1 rounded">${escaped}</code>`;
                }
                try {
                    // Clean the input:
                    // 1. Unescape markdown: \_ -> _, \* -> *, etc.
                    let cleanLatex = latex
                        .replace(/\\_/g, '_')
                        .replace(/\\\*/g, '*')
                        .replace(/\\\[/g, '[')
                        .replace(/\\\]/g, ']');

                    // 1. Extract body if it's a full document
                    const bodyMatch = cleanLatex.match(/\\begin{document}([\s\S]*?)\\end{document}/);
                    if (bodyMatch) {
                        cleanLatex = bodyMatch[1];
                    }

                    // 1b. Strip wrapper environments like "table"
                    cleanLatex = cleanLatex
                        .replace(/\\begin{table}(\[[^\]]+\])?/g, '')
                        .replace(/\\end{table}/g, '');

                    // 2. Convert tabular to array (KaTeX doesn't support tabular)
                    if (cleanLatex.includes('\\begin{tabular}')) {
                        // Replace tabular with array, keeping alignment
                        cleanLatex = cleanLatex
                            .replace(/\\begin{tabular}(\{(@\{\}l+@\{\}|[^}]+)\})?/g, (match, align) => {
                                // Default array alignment if complex tabular alignment
                                return `\\begin{array}{${align && !align.includes('@') ? align.replace(/[{}]/g, '') : 'c|c|c|c|c'}}`;
                            })
                            .replace(/\\end{tabular}/g, '\\end{array}')
                            // Remove unsupported booktabs commands
                            .replace(/\\toprule/g, '\\hline')
                            .replace(/\\midrule/g, '\\hline')
                            .replace(/\\bottomrule/g, '\\hline')
                            .replace(/\\centering/g, '')
                            .replace(/\\caption\{[^}]+\}/g, '');

                        // If no alignment specified, add default center alignment
                        if (!cleanLatex.includes('\\begin{array}{')) {
                            cleanLatex = cleanLatex.replace('\\begin{array}', '\\begin{array}{c|c|c|c|c}');
                        }
                    }

                    cleanLatex = cleanLatex.trim();

                    const rendered = katex.renderToString(cleanLatex, { displayMode, throwOnError: true });
                    // Debug Log
                    if (displayMode) console.log("KaTeX Rendered:", rendered.substring(0, 100) + "...");

                    return displayMode
                        ? `<div class="katex-display my-3 overflow-x-auto">${rendered}</div>`
                        : rendered;
                } catch (e) {
                    console.warn('KaTeX Error:', e.message, 'Input:', latex.substring(0, 100));
                    // Fallback: show raw LaTeX in a styled block
                    const escaped = latex.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    return displayMode
                        ? `<div class="my-3 p-3 bg-slate-800/50 border border-amber-500/30 rounded-lg overflow-x-auto"><code class="text-amber-300 text-xs whitespace-pre">${escaped}</code><div class="text-red-400 text-xs mt-2">‚ö†Ô∏è LaTeX Error: ${e.message}</div></div>`
                        : `<code class="px-1 bg-slate-700 text-amber-300 rounded text-xs">${escaped}</code>`;
                }
            }

            // 0. Handle Markdown Code Blocks containing LaTeX (```latex ... ```)
            let f = text.replace(/```latex([\s\S]+?)```/g, (match, content) => tryRenderKatex(content, true));

            // 0b. Handle generic code blocks that might look like LaTeX (fallback)
            f = f.replace(/```([\s\S]+?)```/g, (match, content) => {
                if (content.includes('begin{array}') || content.includes('$$') || content.includes('\\[')) {
                    return tryRenderKatex(content, true);
                }
                // Return as normal code block if not LaTeX
                return `<pre class="bg-black/30 p-3 rounded-lg overflow-x-auto my-2 text-xs font-mono text-purple-200 border border-white/10">${content.replace(/</g, '&lt;')}</pre>`;
            });

            // 1a. Render display LaTeX blocks ($$...$$)
            f = f.replace(/\$\$([\s\S]+?)\$\$/g, (match, latex) => tryRenderKatex(latex, true));

            // 1b. Render display LaTeX blocks (\[...\])
            f = f.replace(/\\\[([\s\S]+?)\\\]/g, (match, latex) => tryRenderKatex(latex, true));

            // 2a. Render inline LaTeX ($...$)
            f = f.replace(/\$([^\$\n]+?)\$/g, (match, latex) => tryRenderKatex(latex, false));

            // 2b. Render inline LaTeX (\(...\))
            f = f.replace(/\\\(([\s\S]+?)\\\)/g, (match, latex) => tryRenderKatex(latex, false));

            // 3. Bold and Italic
            f = f.replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-amber-200">$1</strong>')
                .replace(/\*(.*?)\*/g, '<em class="text-purple-200/80">$1</em>');

            // 4. Line-by-line formatting
            return f.split('\n').map(l => {
                const t = l.trim();
                if (t.startsWith('-')) return `<div class="flex items-start gap-2 mb-2 ml-1"><span class="text-purple-400 font-bold mt-1">‚Ä¢</span><span class="text-slate-200/90 leading-relaxed">${t.substring(1)}</span></div>`;
                if (/^\d+\./.test(t)) return `<div class="flex items-start gap-2 mb-2 ml-1"><span class="font-bold text-amber-500/80 text-xs mt-1.5">${t.match(/^\d+\./)[0]}</span><span class="text-slate-200/90 leading-relaxed">${t.replace(/^\d+\.\s*/, '')}</span></div>`;
                return t ? `<p class="mb-3 text-slate-200/90 leading-relaxed">${t}</p>` : '<div class="h-2"></div>';
            }).join('');
        }

        function appendMessage(role, text, audioBase64 = null, autoplay = false) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in`;
            const bubble = document.createElement('div');
            bubble.className = `max-w-[85%] md:max-w-[70%] px-5 py-3.5 rounded-2xl text-sm shadow-lg leading-relaxed ${role === 'user' ? 'msg-user rounded-br-none' : 'msg-ai rounded-bl-none'}`;

            let content = role === 'ai' ? formatAiText(text) : `<p>${text.replace(/\n/g, '<br>')}</p>`;

            if (audioBase64) {
                const id = `audio-${Date.now()}`;
                const canvasId = `vis-${Date.now()}`;
                content += `
                    <div class="mt-3 pt-3 border-t border-white/10">
                        <canvas id="${canvasId}" class="visualizer-canvas mb-2"></canvas>
                        <div class="flex items-center gap-2">
                             <button id="btn-${id}" onclick="toggleAudio('${id}')" class="w-8 h-8 flex items-center justify-center bg-white/10 rounded-full hover:bg-white/20 transition text-white"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
                             <div class="flex-grow h-1 bg-white/10 rounded-full overflow-hidden"><div id="bar-${id}" class="h-full bg-purple-500 w-0 transition-all duration-300"></div></div>
                        </div>
                        <audio id="${id}" src="data:audio/wav;base64,${audioBase64}" ${autoplay ? 'autoplay' : ''} class="hidden" 
                            onplay="startVis('${canvasId}',this);updBtn('${id}',1)" onpause="updBtn('${id}',0)" onended="updBtn('${id}',0)" ontimeupdate="updProg('${id}')"></audio>
                    </div>`;
            } else if (role === 'ai' && !text) {
                bubble.innerHTML = '<span class="typing-cursor"></span>';
            }

            if (!bubble.innerHTML) bubble.innerHTML = content;
            div.appendChild(bubble); chatBox.appendChild(div);
            setTimeout(() => chatBox.scrollTop = chatBox.scrollHeight, 100);

            if (role === 'ai' && !audioBase64 && text) typewriter(bubble, content);
        }

        async function typewriter(el, html) {
            const tokens = html.split(/(<[^>]+>)/g).filter(t => t);
            el.innerHTML = '<span class="typing-cursor"></span>';
            const cursor = el.querySelector('.typing-cursor');
            for (const t of tokens) {
                if (t.startsWith('<')) cursor.insertAdjacentHTML('beforebegin', t);
                else {
                    for (const c of t) { cursor.insertAdjacentText('beforebegin', c); await new Promise(r => setTimeout(r, 5)); }
                }
                chatBox.scrollTop = chatBox.scrollHeight;
            }
            cursor.remove();
        }

        // Functions exposed to window for inline onclicks
        window.toggleAudio = (id) => { const a = document.getElementById(id); a.paused ? a.play() : a.pause(); };
        window.updBtn = (id, p) => document.getElementById(`btn-${id}`).innerHTML = p ? '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg>' : '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
        window.updProg = (id) => { const a = document.getElementById(id); if (a) document.getElementById(`bar-${id}`).style.width = (a.currentTime / a.duration) * 100 + '%'; };
        window.startVis = (cid, aud) => {
            const c = document.getElementById(cid); const ctx = c.getContext('2d');
            if (!aud.source) {
                const ac = new (window.AudioContext || window.webkitAudioContext)();
                const src = ac.createMediaElementSource(aud); const an = ac.createAnalyser();
                src.connect(an); an.connect(ac.destination); aud.source = an; aud.ac = ac;
            }
            const an = aud.source; an.fftSize = 64; const len = an.frequencyBinCount; const data = new Uint8Array(len);
            const draw = () => {
                if (aud.paused) return; requestAnimationFrame(draw); an.getByteFrequencyData(data);
                ctx.clearRect(0, 0, c.width, c.height); const w = c.width / len * 2.5;
                for (let i = 0; i < len; i++) {
                    const h = data[i] / 2; ctx.fillStyle = `rgba(168, 85, 247, ${h / 100 + 0.3})`;
                    ctx.fillRect(i * (w + 1), c.height - h, w, h);
                }
            }; draw();
        };

        const loadHistory = async () => {
            const id = document.getElementById('kundaliId').value;
            if (!id) return;
            chatBox.innerHTML = '';
            try {
                const res = await fetch(`${API_BASE}/api/v1/history/${id}?user_id=1`);
                if (res.ok) (await res.json()).forEach(m => appendMessage(m.role, m.text, null, false));
            } catch (e) { }
        };
        document.getElementById('kundaliId').addEventListener('change', loadHistory);
        if (document.getElementById('kundaliId').value) loadHistory();

        // Handle Keydown (Enter to send, Shift+Enter for newline)
        document.getElementById('question').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey) {
                e.preventDefault();
                // Find form and trigger submit
                const form = document.getElementById('askForm');
                const submitEvent = new Event('submit', { cancelable: true });
                form.dispatchEvent(submitEvent);
            }
        });

        document.getElementById('askForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('kundaliId').value;
            const q = document.getElementById('question').value.trim();
            if (!id) return alert('Enter Kundali ID');
            if (!q) return;

            document.getElementById('question').value = '';
            document.getElementById('question').style.height = 'auto'; // Reset textarea
            appendMessage('user', q);

            // Loading bubble
            const loadingId = 'loading-' + Date.now();
            const div = document.createElement('div'); div.id = loadingId; div.className = 'flex animate-fade-in';
            div.innerHTML = `<div class="bg-white/5 border border-white/5 px-4 py-3 rounded-2xl rounded-bl-none text-slate-300 text-xs flex items-center gap-2"><div class="w-2 h-2 bg-purple-500 rounded-full animate-pulse"></div>Consulting stars...</div>`;
            chatBox.appendChild(div); chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const res = await fetch(`${API_BASE}/api/v1/ask`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ kundali_core_id: id, question: q, match_id: urlMatchId || null })
                });

                document.getElementById(loadingId).remove();
                if (!res.ok) throw new Error(await res.text());

                appendMessage('ai', '');
                const bubble = chatBox.lastElementChild.querySelector('.msg-ai');
                const reader = res.body.getReader(); const dec = new TextDecoder();
                let full = '';
                let sources = [];

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const lines = dec.decode(value).split('\n');
                    for (const l of lines) {
                        if (l.trim()) {
                            try {
                                const d = JSON.parse(l);
                                if (d.chunk) { full += d.chunk; bubble.innerHTML = formatAiText(full); chatBox.scrollTop = chatBox.scrollHeight; }
                                if (d.sources) { sources = d.sources; }
                            } catch (e) { }
                        }
                    }
                }

                // Render citations at bottom of bubble
                if (sources.length > 0) {
                    const citationHtml = `
                        <div class="mt-4 pt-3 border-t border-white/10">
                            <div class="text-xs text-slate-400 mb-2">üìö References:</div>
                            <div class="flex flex-wrap gap-2">
                                ${sources.map(s => `
                                    <span class="citation-badge group relative cursor-pointer px-2 py-1 bg-amber-500/10 text-amber-400 rounded text-xs hover:bg-amber-500/20 transition" data-source-id="${s.id}">
                                        [${s.id}] ${s.source.split(' (')[0]}
                                        <div class="citation-tooltip hidden group-hover:block absolute bottom-full left-0 mb-2 w-80 max-h-48 overflow-y-auto p-3 bg-slate-800 border border-amber-500/30 rounded-lg shadow-xl text-slate-200 text-xs z-50">
                                            <div class="font-bold text-amber-400 mb-1">${s.source}</div>
                                            <div class="text-slate-300 leading-relaxed">${s.content.substring(0, 500)}${s.content.length > 500 ? '...' : ''}</div>
                                            <div class="mt-2 text-slate-500">Relevance: ${s.relevance}</div>
                                        </div>
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    bubble.innerHTML += citationHtml;
                }
            } catch (e) {
                if (document.getElementById(loadingId)) document.getElementById(loadingId).remove();
                appendMessage('ai', '‚ö†Ô∏è Cosmic Alignment Error: ' + e.message);
            }
        });

        // Voice
        const vBtn = document.getElementById('voiceBtn');
        let rec;
        vBtn.addEventListener('click', async () => {
            const id = document.getElementById('kundaliId').value;
            if (!id) return alert('Enter ID');

            if (vBtn.classList.contains('recording')) {
                rec.stop();
                vBtn.classList.remove('recording', 'bg-red-500/20', 'text-red-500', 'border-red-500/50');
                vBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 group-hover:scale-110 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>`;
                document.getElementById('recordingStatus').classList.add('hidden');
            } else {
                try {
                    // Determine supported MIME type (prefer webm, fallback to mp4)
                    const mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4';

                    const s = await navigator.mediaDevices.getUserMedia({ audio: true });
                    rec = new MediaRecorder(s, { mimeType });
                    const chunks = [];
                    rec.ondataavailable = e => chunks.push(e.data);
                    rec.onstop = async () => {
                        // Create blob with CORRECT mime type
                        const blob = new Blob(chunks, { type: mimeType });
                        const ext = mimeType.split('/')[1]; // 'webm' or 'mp4'
                        const fd = new FormData(); fd.append('audio', blob, `rec.${ext}`);

                        const loadingId = 'loading-' + Date.now();
                        const div = document.createElement('div'); div.id = loadingId; div.className = 'flex animate-fade-in';
                        div.innerHTML = `<div class="bg-white/5 border border-white/5 px-4 py-3 rounded-2xl rounded-bl-none text-slate-300 text-xs flex items-center gap-2"><div class="w-2 h-2 bg-pink-500 rounded-full animate-bounce"></div>Listening...</div>`;
                        chatBox.appendChild(div);

                        let url = `${API_BASE}/api/v1/voice?kundali_core_id=${id}`;
                        if (urlMatchId) url += `&match_id=${urlMatchId}`;

                        const res = await fetch(url, { method: 'POST', body: fd });
                        document.getElementById(loadingId).remove();
                        if (res.ok) {
                            const reader = res.body.getReader();
                            const dec = new TextDecoder();

                            let fullUserText = '';
                            let fullAiText = '';
                            let audioBase64 = null;
                            let buffer = '';
                            let aiBubble = null; // Lazy load

                            while (true) {
                                const { done, value } = await reader.read();
                                if (done) break;

                                buffer += dec.decode(value, { stream: true });
                                const lines = buffer.split('\n');

                                // Process all complete lines
                                buffer = lines.pop(); // Keep the last partial line in buffer

                                for (const line of lines) {
                                    const trimmed = line.trim();
                                    if (!trimmed) continue;

                                    try {
                                        let data;
                                        if (trimmed.startsWith('data: ')) {
                                            data = JSON.parse(trimmed.substring(6));
                                        } else if (trimmed.startsWith('{')) {
                                            data = JSON.parse(trimmed);
                                        } else {
                                            continue;
                                        }

                                        // Handle events based on "type"
                                        switch (data.type) {
                                            case 'transcription':
                                                fullUserText = data.text;
                                                appendMessage('user', fullUserText);
                                                break;

                                            case 'text':
                                                if (data.chunk) {
                                                    // Lazy create AI bubble if not exists
                                                    if (!aiBubble) {
                                                        appendMessage('ai', '');
                                                        const bubbles = chatBox.getElementsByClassName('msg-ai');
                                                        aiBubble = bubbles[bubbles.length - 1];
                                                    }

                                                    fullAiText += data.chunk;
                                                    aiBubble.innerHTML = formatAiText(fullAiText);
                                                    chatBox.scrollTop = chatBox.scrollHeight;
                                                }
                                                break;

                                            case 'audio':
                                                if (data.chunk) {
                                                    if (!audioBase64) audioBase64 = "";
                                                    audioBase64 += data.chunk;
                                                }
                                                break;
                                        }
                                    } catch (e) {
                                        console.warn('SSE Parse Error', e);
                                    }
                                }
                            }

                            // If we got audio, inject the player into the AI bubble
                            if (audioBase64) {
                                const id = `audio-${Date.now()}`;
                                const canvasId = `vis-${Date.now()}`;
                                const playerHtml = `
                                    <div class="mt-3 pt-3 border-t border-white/10">
                                        <canvas id="${canvasId}" class="visualizer-canvas mb-2"></canvas>
                                        <div class="flex items-center gap-2">
                                             <button id="btn-${id}" onclick="toggleAudio('${id}')" class="w-8 h-8 flex items-center justify-center bg-white/10 rounded-full hover:bg-white/20 transition text-white"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
                                             <div class="flex-grow h-1 bg-white/10 rounded-full overflow-hidden"><div id="bar-${id}" class="h-full bg-purple-500 w-0 transition-all duration-300"></div></div>
                                        </div>
                                        <audio id="${id}" src="data:audio/wav;base64,${audioBase64}" autoplay class="hidden" 
                                            onplay="startVis('${canvasId}',this);updBtn('${id}',1)" onpause="updBtn('${id}',0)" onended="updBtn('${id}',0)" ontimeupdate="updProg('${id}')"></audio>
                                    </div>`;
                                aiBubble.innerHTML += playerHtml;
                            }
                        }
                    };
                    rec.start();
                    vBtn.classList.add('recording', 'bg-red-500/20', 'text-red-500', 'border-red-500/50');
                    vBtn.innerHTML = '<div class="w-3 h-3 bg-red-500 rounded-sm animate-pulse"></div>';
                    document.getElementById('recordingStatus').classList.remove('hidden');
                    document.getElementById('recordingStatus').classList.add('flex');
                } catch (e) { alert('Mic blocked'); }
            }
        });
    </script>
</body>

</html>