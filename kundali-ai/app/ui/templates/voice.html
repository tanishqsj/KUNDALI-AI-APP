<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen font-sans">
    <nav class="bg-indigo-700 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex flex-wrap justify-between items-center">
            <a href="index.html" class="text-2xl font-bold tracking-wider flex items-center gap-2"><span>üîÆ</span> KUNDALI AI</a>
            <div class="flex gap-4 text-sm font-medium overflow-x-auto">
                <a href="index.html" class="hover:text-indigo-200 transition">Home</a>
                <a href="create.html" class="hover:text-indigo-200 transition">Create</a>
                <a href="ask.html" class="hover:text-indigo-200 transition">Ask AI</a>
                <a href="voice.html" class="text-white border-b-2 border-white">Voice</a>
                <a href="report.html" class="hover:text-indigo-200 transition">Reports</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto mt-10 p-4 max-w-xl text-center">
        <div class="bg-white rounded-xl shadow-lg p-8">
            <h2 class="text-3xl font-bold mb-8 text-slate-800">Voice Interaction</h2>
            
            <div class="mb-8 text-left">
                <label class="text-xs font-bold text-slate-500 uppercase">Kundali ID</label>
                <input type="text" id="kundaliId" class="w-full border border-slate-300 p-2 rounded-lg mt-1 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Enter UUID...">
            </div>

            <div class="space-y-6 flex flex-col items-center">
                <button id="recordBtn" class="bg-red-500 text-white w-24 h-24 rounded-full shadow-xl hover:bg-red-600 focus:outline-none transition-all transform hover:scale-105 flex items-center justify-center relative">
                    <span id="btnIcon" class="text-4xl">üéôÔ∏è</span>
                    <span id="pulseRing" class="absolute w-full h-full rounded-full border-4 border-red-400 opacity-0"></span>
                </button>
                <p id="status" class="text-slate-500 font-medium">Tap microphone to start recording</p>
            </div>

            <div id="responseArea" class="mt-10 hidden text-left border-t border-slate-100 pt-6 animate-fade-in">
                <div class="mb-4">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-1">You Asked:</p>
                    <p id="qText" class="font-medium text-slate-800 bg-slate-50 p-3 rounded-lg">...</p>
                </div>
                
                <div class="mb-4">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-1">AI Answer:</p>
                    <p id="aText" class="font-medium text-indigo-700 bg-indigo-50 p-3 rounded-lg">...</p>
                </div>
                
                <audio id="audioPlayer" controls class="w-full mt-4"></audio>
            </div>
        </div>
    </div>

    <script>
        const getApiBaseUrl = () => {
            if (window.location.protocol === 'file:') return 'http://127.0.0.1:8000';
            return '';
        };
        const API_BASE = getApiBaseUrl();

        const storedId = localStorage.getItem('kundali_core_id');
        if (storedId) document.getElementById('kundaliId').value = storedId;

        let mediaRecorder;
        let audioChunks = [];
        const recordBtn = document.getElementById('recordBtn');
        const status = document.getElementById('status');
        const pulseRing = document.getElementById('pulseRing');

        recordBtn.addEventListener('click', async () => {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                // Start Recording
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                    
                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        sendAudio(audioBlob);
                    };

                    mediaRecorder.start();
                    status.innerText = "Recording... Tap to stop.";
                    pulseRing.classList.add('animate-ping', 'opacity-75');
                } catch (err) {
                    alert("Microphone access denied or error: " + err.message);
                }
            } else {
                // Stop Recording
                mediaRecorder.stop();
                status.innerText = "Processing audio...";
                pulseRing.classList.remove('animate-ping', 'opacity-75');
            }
        });

        async function sendAudio(blob) {
            const id = document.getElementById('kundaliId').value;
            if (!id) return alert("Please enter a Kundali ID first.");

            const formData = new FormData();
            formData.append('audio', blob, 'recording.wav');

            try {
                const res = await fetch(`${API_BASE}/api/v1/voice?kundali_core_id=${id}`, { method: 'POST', body: formData });
                const data = await res.json();

                document.getElementById('responseArea').classList.remove('hidden');
                document.getElementById('qText').innerText = data.question_text || "(No text detected)";
                document.getElementById('aText').innerText = typeof data.answer_text === 'string' ? data.answer_text : JSON.stringify(data.answer_text);
                
                const audioPlayer = document.getElementById('audioPlayer');
                if(data.audio_bytes) {
                    audioPlayer.src = "data:audio/wav;base64," + data.audio_bytes;
                    audioPlayer.play();
                }
                status.innerText = "Ready.";
            } catch (e) { 
                alert(e.message + (e.message === 'Failed to fetch' ? ' (Check CORS/Backend)' : '')); 
                status.innerText = "Error occurred."; 
            }
        }
    </script>
</body>
</html>